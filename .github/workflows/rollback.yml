name: Rollback

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Rollback environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: ghcr.io
  COMPOSE_FILE: docker-compose.yml:docker-compose.ci.yml
  UID: 1000
  GID: 1000

jobs:
  rollback:
    name: Rollback ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    permissions:
      contents: read
      packages: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set image name to lowercase
        run: |
          IMAGE_ID=$(echo "ghcr.io/${{ github.repository }}/php-app" | tr '[:upper:]' '[:lower:]')
          echo "IMAGE_NAME=$IMAGE_ID:latest" >> $GITHUB_ENV

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Restore Vendor Cache
        uses: actions/cache/restore@v3
        with:
          path: vendor
          key: vendor-${{ hashFiles('composer.lock') }}

      - name: Pull Docker Image
        run: |
          export IMAGE_NAME=${{ env.IMAGE_NAME }}
          make docker-pull

      - name: Setup SSH for deployment
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}

      - name: Add known hosts
        run: |
          if [ "${{ github.event.inputs.environment }}" = "production" ]; then
            ssh-keyscan -H production.example.com >> ~/.ssh/known_hosts
          else
            ssh-keyscan -H staging.example.com >> ~/.ssh/known_hosts
          fi

      - name: List current releases
        run: |
          export IMAGE_NAME=${{ env.IMAGE_NAME }}
          make deploy-list stage=${{ github.event.inputs.environment }}

      - name: Rollback ${{ github.event.inputs.environment }}
        run: |
          export IMAGE_NAME=${{ env.IMAGE_NAME }}
          make deploy-rollback stage=${{ github.event.inputs.environment }}

      - name: Notify rollback success
        run: |
          echo "‚è™ Rollback on ${{ github.event.inputs.environment }} completed successfully!"
          echo "Previous release is now active."
