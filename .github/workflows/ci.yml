name: CI

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  # Build Docker image and install dependencies once
  setup:
    name: Setup Environment
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker Image
        run: docker compose -f docker-compose.yml -f docker-compose.ci.yml build
      
      - name: Install Dependencies
        run: |
          export COMPOSE_FILE=docker-compose.yml:docker-compose.ci.yml
          make setup
      
      - name: Cache Vendor Directory
        uses: actions/cache/save@v3
        with:
          path: vendor
          key: vendor-${{ hashFiles('composer.lock') }}

  # Fast checks and architecture
  quality:
    name: Code Quality & Architecture
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v4
      
      - name: Restore Vendor Cache
        uses: actions/cache/restore@v3
        with:
          path: vendor
          key: vendor-${{ hashFiles('composer.lock') }}
      
      - name: Build Docker Image
        run: docker compose -f docker-compose.yml -f docker-compose.ci.yml build

      - name: Set Compose Files
        run: echo "COMPOSE_FILE=docker-compose.yml:docker-compose.ci.yml" >> $GITHUB_ENV

      - name: Code Style (CS Fixer)
        run: make cs-check

      - name: Code Style (PHPCS)
        run: make phpcs-check

      - name: Rector Analysis
        run: make rector-check

      - name: Architecture (Deptrac)
        run: make deptrac

  # Deep static analysis
  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v4
      
      - name: Restore Vendor Cache
        uses: actions/cache/restore@v3
        with:
          path: vendor
          key: vendor-${{ hashFiles('composer.lock') }}
      
      - name: Build Docker Image
        run: docker compose -f docker-compose.yml -f docker-compose.ci.yml build

      - name: Set Compose Files
        run: echo "COMPOSE_FILE=docker-compose.yml:docker-compose.ci.yml" >> $GITHUB_ENV

      - name: PHPStan
        run: make phpstan

      - name: Psalm
        run: make psalm

  # Functional and Unit tests
  tests:
    name: Tests (Unit & Behavior)
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v4
      
      - name: Restore Vendor Cache
        uses: actions/cache/restore@v3
        with:
          path: vendor
          key: vendor-${{ hashFiles('composer.lock') }}
      
      - name: Build Docker Image
        run: docker compose -f docker-compose.yml -f docker-compose.ci.yml build

      - name: Set Compose Files
        run: echo "COMPOSE_FILE=docker-compose.yml:docker-compose.ci.yml" >> $GITHUB_ENV

      - name: PHPUnit
        run: make phpunit

      - name: PHPSpec
        run: make spec

      - name: Behat
        run: make behat

  # Mutation testing (usually slow)
  mutation:
    name: Mutation Testing
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v4
      
      - name: Restore Vendor Cache
        uses: actions/cache/restore@v3
        with:
          path: vendor
          key: vendor-${{ hashFiles('composer.lock') }}
      
      - name: Build Docker Image
        run: docker compose -f docker-compose.yml -f docker-compose.ci.yml build

      - name: Set Compose Files
        run: echo "COMPOSE_FILE=docker-compose.yml:docker-compose.ci.yml" >> $GITHUB_ENV

      - name: Infection
        run: make infection
